<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CMDS Program Editor</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    />
    <style>
      :root {
        --bg-color: #f5f5f5;
        --text-color: #000;
        --input-bg: #fff;
        --input-border: #ccc;
      }
      [data-theme="dark"] {
        --bg-color: #121212;
        --text-color: #f0f0f0;
        --input-bg: #1e1e1e;
        --input-border: #444;
      }
      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: Arial, sans-serif;
        transition: background-color 0.3s, color 0.3s;
      }
      input,
      select {
        background-color: var(--input-bg);
        color: var(--text-color);
        border: 1px solid var(--input-border);
        padding: 5px;
        border-radius: 4px;
      }
      .section-header {
        font-weight: bold;
        font-size: 1rem;
        margin-top: 1.5rem;
      }
      .collapsed {
        display: none;
      }
      .program-section {
        border-top: 1px solid var(--input-border);
        margin-bottom: 1.25rem;
        padding-top: 0.75rem;
      }
    </style>
  </head>
  <body class="p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">DCS DTC Web Editor</h1>
      <button onclick="toggleDarkMode()" id="themeToggle" class="px-4 py-2 border rounded">
        Toggle Dark Mode
      </button>
    </div>

    <div class="mb-6">
      <p class="mb-2 text-sm">An online DTC Web Editor for DCS</p>
      <p class="mb-2 text-sm">By DSplayer</p>
    </div>

    <div class="mb-4 flex gap-4">
      <label for="aircraftSelect" class="font-semibold">Select Aircraft:</label>
      <select id="aircraftSelect" class="border p-1 rounded">
        <option value="FA-18C_hornet">F/A-18C Hornet</option>
        <option value="F-16C_50">F-16C Block 50</option>
      </select>
    </div>

    <div id="tabButtons" class="mb-4 flex gap-4"></div>

    <div class="mb-6">
      <p class="mb-2 text-sm">Upload your already existing DTC here:</p>
      <input type="file" id="fileInput" accept="application/DTC" class="mb-4" />
    </div>

    <!-- PROGRAM SETTINGS TAB -->
    <div id="programTab" class="space-y-6">
      <!-- First row: Global Delay + Bingo -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
        <!-- Global AUTO Delay -->
        <div>
          <label class="block mb-1 font-semibold">Global AUTO Delay Between Programs (sec):</label>
          <input type="number" id="globalDelay" step="0.25" min="0" max="99" class="w-32" />
        </div>

        <!-- Bingo Settings (only visible for F-16) -->
        <div id="bingoSettingsContainer" class="hidden">
          <label class="block mb-1 font-semibold">Bingo Settings</label>
          <div class="grid grid-cols-2 gap-4" id="bingoSettingsFields"></div>
        </div>
      </div>

      <!-- Second row: Auto / Manual -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
        <!-- AUTO PROGRAMS -->
        <div id="autoPrograms">
          <h2 class="text-lg font-semibold mb-2">AUTO Programs</h2>
        </div>

        <!-- MANUAL PROGRAMS -->
        <div id="manualPrograms">
          <h2 class="text-lg font-semibold mb-2">Manual Programs</h2>
        </div>
      </div>
    </div>
    <!-- THREAT TABLE TAB -->
    <div id="threatTab" class="hidden">
      <h2 class="text-xl font-bold mb-2">CMDS Threat Table</h2>

      <input
        type="text"
        id="threatSearch"
        placeholder="Search threats..."
        class="mb-2 px-2 py-1 border rounded w-full max-w-md"
      />

      <div class="mb-4 flex gap-2">
        <button onclick="switchThreatCategory('Air')" class="px-3 py-1 border rounded" id="cat-Air">
          Air
        </button>
        <button
          onclick="switchThreatCategory('Ground')"
          class="px-3 py-1 border rounded"
          id="cat-Ground"
        >
          Ground
        </button>
        <button
          onclick="switchThreatCategory('Naval')"
          class="px-3 py-1 border rounded"
          id="cat-Naval"
        >
          Naval
        </button>
        <button
          onclick="switchThreatCategory('Other')"
          class="px-3 py-1 border rounded"
          id="cat-Other"
        >
          Other
        </button>
      </div>

      <table class="w-full text-sm border-collapse">
        <thead>
          <tr class="border-b">
            <th class="p-2 text-left">#</th>
            <th class="p-2 text-left">THREAT RADAR</th>
            <th class="p-2 text-left">THRESHOLD</th>
            <th class="p-2 text-left">PROGRAM</th>
          </tr>
        </thead>
        <tbody id="threatTableBody"></tbody>
      </table>
    </div>

    <!-- COMM TAB -->
    <div id="commTab" class="hidden">
      <h2 class="text-xl font-bold mb-4">COMM Channels</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div id="comm1Section">
          <h3 class="font-semibold mb-2">COMM1</h3>
          <table class="w-full text-sm border-collapse">
            <thead>
              <tr class="border-b">
                <th class="p-2 text-left">Channel</th>
                <th class="p-2 text-left">Frequency</th>
                <th class="p-2 text-left">Modulation</th>
                <th class="p-2 text-left">Name</th>
              </tr>
            </thead>
            <tbody id="comm1Body"></tbody>
          </table>
        </div>
        <div id="comm2Section">
          <h3 class="font-semibold mb-2">COMM2</h3>
          <table class="w-full text-sm border-collapse">
            <thead>
              <tr class="border-b">
                <th class="p-2 text-left">Channel</th>
                <th class="p-2 text-left">Frequency</th>
                <th class="p-2 text-left">Modulation</th>
                <th class="p-2 text-left">Name</th>
              </tr>
            </thead>
            <tbody id="comm2Body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="mt-6 flex gap-4 items-center">
      <label for="filename">Filename:</label>
      <input type="text" id="filename" value="DTC_Custom.DTC" />
      <button onclick="downloadJson()" class="px-4 py-2 bg-blue-600 text-white rounded">
        Download DTC
      </button>
    </div>
    <script>
      function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
      }

      let jsonData = null;
      let currentThreatCategory = "Air";
      let currentAircraftType = "FA-18C_hornet";
      let currentTabId = "programTab";

      const aircraftCapabilities = {
        "FA-18C_hornet": {
          hasPrograms: true,
          hasThreatTable: true,
          hasComm: true,
        },
        "F-16C_50": {
          hasPrograms: true,
          hasThreatTable: true,
          hasComm: true,
        },
      };

      const dtcPaths = {
        "FA-18C_hornet": {
          programSettings: () => jsonData?.data?.ALR67?.CMDS?.CMDSProgramSettings,
          threatTable: () => jsonData?.data?.ALR67?.CMDS?.CMDS_Threat_table,
          delayBetweenPrograms: () => jsonData?.data?.ALR67?.CMDS?.delay_between_programs,
        },
        "F-16C_50": {
          bingoSettings: () => jsonData?.data?.MPD?.CMDS?.CMDSBingoSettings,
          programSettings: () => jsonData?.data?.MPD?.CMDS?.CMDSProgramSettings,
          threatTable: () => jsonData?.data?.MPD?.CMDS?.CMDSPrograms,
          delayBetweenPrograms: () => jsonData?.data?.MPD?.CMDS?.CMDSPrograms?.delayBetweenPrograms,
        },
      };

      const CMDS_FIELD_MAP = {
        "FA-18C_hornet": {
          paramMap: {
            Quantity: { key: "Quantity", label: "Qty" },
            Repeat: { key: "Repeat", label: "Repeat" },
            Interval: { key: "Interval", label: "Interval" },
          },
          delayKey: "delay_between_programs",
          getField: (fields, type, param) => fields[type]?.[param],
          setField: (fields, type, param, value) => {
            if (fields[type]) fields[type][param] = value;
          },
        },
        "F-16C_50": {
          paramMap: {
            SalvoQuantity: { key: "SalvoQuantity", label: "Salvo Qty" },
            BurstQuantity: { key: "BurstQuantity", label: "Burst Qty" },
            SalvoInterval: { key: "SalvoInterval", label: "Salvo Int." },
            BurstInterval: { key: "BurstInterval", label: "Burst Int." },
          },
          delayKey: "delayBetweenPrograms",
          getField: (fields, type, param) => fields[type?.toLowerCase()]?.[param],
          setField: (fields, type, param, value) => {
            const t = type?.toLowerCase();
            if (fields[t]) fields[t][param] = value;
          },
        },
      };

      function updateTabVisibilityForAircraft(type) {
        const caps = aircraftCapabilities[type] || {};

        renderTabButtons();

        toggleElement("programTab", caps.hasPrograms);
        toggleElement("threatTab", caps.hasThreatTable);
        toggleElement("commTab", caps.hasComm);

        const validTab = caps[`has${capitalize(currentTabId.replace("Tab", ""))}`] ?? false;

        if (!validTab) {
          if (caps.hasPrograms) currentTabId = "programTab";
          else if (caps.hasThreatTable) currentTabId = "threatTab";
          else if (caps.hasComm) currentTabId = "commTab";
        }

        switchTab(currentTabId);
      }

      function toggleElement(id, show) {
        const el = document.getElementById(id);
        if (!el) return;
        if (show) {
          el.classList.remove("hidden");
        } else {
          el.classList.add("hidden");
        }
      }

      const friendlyNames = {
        AUTO_1: "Auto 1",
        AUTO_2: "Auto 2",
        AUTO_3: "Auto 3",
        AUTO_4: "Auto 4",
        BYP: "Bypass",
        MAN_1: "Manual 1",
        MAN_2: "Manual 2",
        MAN_3: "Manual 3",
        MAN_4: "Manual 4",
        MAN_5: "Manual 5",
        MAN_6: "Manual 6",
        SEMI: "Semi-Auto",
        NONE: "None",
      };

      function applyTheme() {
        const theme =
          localStorage.getItem("theme") ||
          (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
        document.documentElement.setAttribute("data-theme", theme);
        document.getElementById("themeToggle").textContent =
          theme === "dark" ? "Light Mode" : "Dark Mode";
      }

      function toggleDarkMode() {
        const currentTheme = document.documentElement.getAttribute("data-theme");
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        document.documentElement.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        applyTheme();
      }

      function renderTabButtons() {
        const container = document.getElementById("tabButtons");
        container.innerHTML = "";

        const caps = aircraftCapabilities[currentAircraftType];

        const tabs = [
          {
            id: "programTab",
            label: "Countermeasure Programs",
            capability: "hasPrograms",
            btnId: "tabProgramsBtn",
          },
          {
            id: "threatTab",
            label: "Threat Table",
            capability: "hasThreatTable",
            btnId: "tabThreatsBtn",
          },
          {
            id: "commTab",
            label: "Communications",
            capability: "hasComm",
            btnId: "tabCommBtn",
          },
        ];

        tabs.forEach(({ id, label, capability, btnId }) => {
          if (!caps[capability]) return;
          const btn = document.createElement("button");
          btn.id = btnId;
          btn.textContent = label;
          btn.className = "px-4 py-2 border rounded";
          btn.onclick = () => switchTab(id);
          container.appendChild(btn);
        });
      }

      function switchTab(tabId) {
        const allTabs = ["programTab", "threatTab", "commTab"];
        allTabs.forEach((t) => document.getElementById(t)?.classList.add("hidden"));

        const allButtons = ["tabProgramsBtn", "tabThreatsBtn", "tabCommBtn"];
        allButtons.forEach((b) =>
          document.getElementById(b)?.classList.remove("bg-blue-600", "text-white")
        );

        const tabElement = document.getElementById(tabId);
        const buttonElement = {
          programTab: "tabProgramsBtn",
          threatTab: "tabThreatsBtn",
          commTab: "tabCommBtn",
        }[tabId];

        if (!tabElement || !document.getElementById(buttonElement)) return;

        tabElement.classList.remove("hidden");
        document.getElementById(buttonElement).classList.add("bg-blue-600", "text-white");

        if (tabId === "threatTab") {
          currentThreatCategory = "Air";
          switchThreatCategory("Air");
        } else if (tabId === "commTab") {
          renderCommTab();
        }
        currentTabId = tabId;
      }

      function switchThreatCategory(category) {
        currentThreatCategory = category;
        renderThreatTable(category);

        ["Air", "Ground", "Naval", "Other"].forEach((cat) => {
          document.getElementById(`cat-${cat}`).classList.remove("bg-blue-600", "text-white");
        });
        document.getElementById(`cat-${category}`).classList.add("bg-blue-600", "text-white");
      }

      function renderThreatTable(category) {
        const tableBody = document.getElementById("threatTableBody");
        tableBody.innerHTML = "";

        let rows = [];
        const threatData = dtcPaths[currentAircraftType]?.threatTable?.();

        if (currentAircraftType === "FA-18C_hornet") {
          rows = threatData?.[category] || [];
        } else if (currentAircraftType === "F-16C_50") {
          // F-16 threat table has different structure
          if (threatData) {
            rows = Object.values(threatData).filter(
              (entry) =>
                entry.category === category ||
                (category === "Other" && !["Air", "Ground", "Naval"].includes(entry.category))
            );
          }
        }

        const searchQuery = document.getElementById("threatSearch")?.value?.toLowerCase() || "";
        const filteredRows = rows.filter((entry) => {
          const name = entry.group_name?.toLowerCase() || entry.name?.toLowerCase() || "";
          const hint = entry.hint?.toLowerCase() || "";
          return name.includes(searchQuery) || hint.includes(searchQuery);
        });

        filteredRows.forEach((entry, index) => {
          const tr = document.createElement("tr");
          tr.className = "border-b";

          // Row #
          const tdIndex = document.createElement("td");
          tdIndex.className = "p-2";
          tdIndex.textContent = index + 1;
          tr.appendChild(tdIndex);

          // Threat Radar
          const tdName = document.createElement("td");
          tdName.className = "p-2";
          tdName.textContent = entry.group_name || entry.name || entry.hint || "Unknown";
          if (entry.hint) {
            tdName.title = entry.hint.replace(/\n/g, ", ");
          }
          tr.appendChild(tdName);

          // Threshold
          const tdThresh = document.createElement("td");
          tdThresh.className = "p-2";
          const selThresh = document.createElement("select");

          (entry.thresholds || []).forEach((th) => {
            const option = document.createElement("option");
            option.value = th.label || th;
            option.textContent = th.label || th;
            if (entry.default_threshold?.label === th.label || entry.defaultThreshold === th) {
              option.selected = true;
            }
            selThresh.appendChild(option);
          });

          selThresh.onchange = () => {
            if (currentAircraftType === "FA-18C_hornet") {
              entry.default_threshold.label = selThresh.value;
            } else {
              entry.defaultThreshold = selThresh.value;
            }
          };

          tdThresh.appendChild(selThresh);
          tr.appendChild(tdThresh);

          // Program
          const tdProg = document.createElement("td");
          tdProg.className = "p-2";
          const selProg = document.createElement("select");

          Object.entries(friendlyNames)
            .filter(([k]) => k.startsWith("AUTO_"))
            .forEach(([key, label]) => {
              const num = parseInt(key.split("_")[1]);
              const option = document.createElement("option");
              option.value = num;
              option.textContent = label;
              if (entry.program === num) option.selected = true;
              selProg.appendChild(option);
            });

          selProg.onchange = () => {
            entry.program = parseInt(selProg.value);
          };

          tdProg.appendChild(selProg);
          tr.appendChild(tdProg);

          tableBody.appendChild(tr);
        });
      }

      function renderCommTab() {
        const commRoot = jsonData?.data?.COMM;
        if (!commRoot || !commRoot.COMM1 || !commRoot.COMM2) {
          console.warn("COMM1 or COMM2 missing in JSON structure");
          return;
        }

        const comm1 = commRoot.COMM1;
        const comm2 = commRoot.COMM2;

        const comm1Body = document.getElementById("comm1Body");
        const comm2Body = document.getElementById("comm2Body");
        comm1Body.innerHTML = "";
        comm2Body.innerHTML = "";

        const renderCommTable = (comm, tbody, commKey) => {
          Object.entries(comm)
            .filter(([key]) => key.startsWith("Channel_"))
            .sort((a, b) => {
              const getSortKey = (k) => {
                const match = k.match(/^Channel_(\d+)$/);
                return match ? parseInt(match[1]) : k;
              };
              return getSortKey(a[0]) - getSortKey(b[0]);
            })
            .forEach(([chan, details]) => {
              const tr = document.createElement("tr");
              tr.className = "border-b";

              const tdChan = document.createElement("td");
              tdChan.className = "p-2";
              tdChan.textContent = chan.replace("Channel_", "Channel ");
              tr.appendChild(tdChan);

              const tdFreq = document.createElement("td");
              tdFreq.className = "p-2";
              const freqInput = document.createElement("input");
              freqInput.type = "number";
              freqInput.step = "0.01";
              freqInput.value = details.frequency ?? details.freq ?? "";
              freqInput.className = "w-24";
              freqInput.onblur = () => {
                const val = parseFloat(freqInput.value);
                if (!isNaN(val)) {
                  if ("frequency" in details) details.frequency = val;
                  else if ("freq" in details) details.freq = val;
                } else {
                  freqInput.value = details.frequency ?? details.freq ?? "";
                }
              };
              tdFreq.appendChild(freqInput);
              tr.appendChild(tdFreq);

              const tdMod = document.createElement("td");
              tdMod.className = "p-2";
              const selMod = document.createElement("select");
              ["AM", "FM"].forEach((label, idx) => {
                const opt = new Option(label, idx);
                if (details.modulation == idx) opt.selected = true;
                selMod.appendChild(opt);
              });
              selMod.onchange = () => {
                details.modulation = parseInt(selMod.value);
              };
              tdMod.appendChild(selMod);
              tr.appendChild(tdMod);

              const tdName = document.createElement("td");
              tdName.className = "p-2";
              const nameInput = document.createElement("input");
              nameInput.type = "text";
              nameInput.value = details.name ?? `CH ${chan.replace("Channel_", "")}`;
              nameInput.className = "w-24";
              nameInput.onblur = () => {
                if ("name" in details || currentAircraftType === "FA-18C_hornet") {
                  details.name = nameInput.value;
                }
              };

              tdName.appendChild(nameInput);
              tr.appendChild(tdName);

              tbody.appendChild(tr);
            });

          if ("Guard" in comm && currentAircraftType === "FA-18C_hornet") {
            const trGuard = document.createElement("tr");
            trGuard.innerHTML = `<td colspan="4" class="p-2 pt-4">
        <label><input type="checkbox" id="guardToggle-${commKey}" ${
              comm.Guard ? "checked" : ""
            }/> Guard Enabled</label>
      </td>`;
            tbody.appendChild(trGuard);

            const guardInput = trGuard.querySelector("input[type='checkbox']");
            guardInput.onchange = () => {
              comm.Guard = guardInput.checked;
            };
          }
        };

        renderCommTable(comm1, comm1Body, "comm1");
        renderCommTable(comm2, comm2Body, "comm2");
      }

      function renderConfigurator() {
        const settings = dtcPaths[currentAircraftType]?.programSettings?.();
        if (!settings) return;

        const isF16 = currentAircraftType === "F-16C_50";
        const autoContainer = document.getElementById("autoPrograms");
        const manContainer = document.getElementById("manualPrograms");

        autoContainer.innerHTML = "";
        manContainer.innerHTML = "";

        // Top row: Delay + Bingo Settings (aligned)
        const topRow = document.createElement("div");
        topRow.className = "grid grid-cols-1 md:grid-cols-2 gap-6 mb-6";

        // --- Global Delay ---
        const delayBox = document.createElement("div");
        delayBox.innerHTML = `
    <label class="block font-medium mb-1">Global AUTO Delay Between Programs (sec):</label>
    <input type="number" id="globalDelay" step="0.25" min="0" max="99" class="w-32" />
  `;
        const delayInput = delayBox.querySelector("input");
        const delayVal = dtcPaths[currentAircraftType]?.delayBetweenPrograms?.();
        if (typeof delayVal === "number") {
          delayInput.value = delayVal;
          delayInput.onblur = () => {
            let v = parseFloat(delayInput.value);
            if (!isNaN(v)) {
              v = Math.round(v / 0.25) * 0.25;
              v = Math.max(0, Math.min(99, v));
              delayInput.value = v;
              if (currentAircraftType === "FA-18C_hornet")
                jsonData.data.ALR67.CMDS.delay_between_programs = v;
              else if (isF16) jsonData.data.MPD.CMDS.delayBetweenPrograms = v;
            }
          };
        }
        topRow.appendChild(delayBox);

        // --- Bingo Settings (F-16 only) ---
        if (isF16) {
          const bingo = dtcPaths["F-16C_50"]?.bingoSettings?.();
          if (bingo) {
            const bingoBox = document.createElement("div");

            const title = document.createElement("h3");
            title.className = "text-lg font-semibold mb-2";
            title.textContent = "Bingo Settings";
            bingoBox.appendChild(title);

            const fieldRow = document.createElement("div");
            fieldRow.className = "flex gap-4 flex-wrap mb-4";

            [
              { label: "Chaff", key: "ChaffNum" },
              { label: "Flare", key: "FlaresNum" },
              { label: "Other1", key: "Other1Num" },
              { label: "Other2", key: "Other2Num" },
            ].forEach(({ label, key }) => {
              const col = document.createElement("div");
              col.className = "flex flex-col";
              const lbl = document.createElement("label");
              lbl.textContent = `${label} Qty`;
              const input = document.createElement("input");
              input.type = "number";
              input.className = "w-20";
              input.value = bingo[key];
              input.onblur = () => {
                const val = parseInt(input.value);
                if (!isNaN(val)) bingo[key] = Math.max(0, Math.min(99, val));
                else input.value = bingo[key];
              };
              col.appendChild(lbl);
              col.appendChild(input);
              fieldRow.appendChild(col);
            });

            bingoBox.appendChild(fieldRow);

            [
              { label: "BINGO Warning", key: "BINGO" },
              { label: "Feedback (FDBK)", key: "FDBK" },
              { label: "Request Counter (REQCTR)", key: "REQCTR" },
            ].forEach(({ label, key }) => {
              const cbDiv = document.createElement("div");
              cbDiv.className = "mb-2";
              const cb = document.createElement("input");
              cb.type = "checkbox";
              cb.checked = bingo[key];
              cb.onchange = () => (bingo[key] = cb.checked);
              const lbl = document.createElement("label");
              lbl.className = "ml-2";
              lbl.textContent = label;
              cbDiv.appendChild(cb);
              cbDiv.appendChild(lbl);
              bingoBox.appendChild(cbDiv);
            });

            topRow.appendChild(bingoBox);
          }
        }

        autoContainer.appendChild(topRow);

        // Section headers aligned
        autoContainer.innerHTML += '<h2 class="text-lg font-semibold mb-2">AUTO Programs</h2>';
        manContainer.innerHTML += '<h2 class="text-lg font-semibold mb-2">Manual Programs</h2>';

        const manualSections = [];
        let bypassSection = null;

        Object.entries(settings).forEach(([program, fields]) => {
          if (typeof fields !== "object") return;

          const section = document.createElement("div");
          section.className = "program-section";

          const header = document.createElement("div");
          header.className = "section-header";
          header.textContent = friendlyNames[program] || program;

          const content = document.createElement("div");
          content.className = "space-y-2 mt-2";

          header.addEventListener("click", () => content.classList.toggle("collapsed"));

          const paramMap = isF16
            ? { Quantity: "SalvoQuantity", Repeat: "BurstQuantity", Interval: "SalvoInterval" }
            : { Quantity: "Quantity", Repeat: "Repeat", Interval: "Interval" };

          ["Quantity", "Repeat", "Interval"].forEach((param) => {
            const row = document.createElement("div");
            row.className = "flex gap-4 items-end";

            ["Chaff", "Flare", "Other1", "Other2"].forEach((type) => {
              const typeData = fields[type];
              if (!typeData || typeData[paramMap[param]] === undefined) return;

              const col = document.createElement("div");
              col.className = "flex flex-col";
              const label = document.createElement("label");
              label.textContent = param === "Quantity" ? `${type} Qty` : param;
              const input = document.createElement("input");
              input.type = "number";
              input.step = param === "Interval" ? 0.25 : 1;
              input.min = param === "Interval" ? 0.25 : 1;
              input.max = param === "Interval" ? 5 : 100;
              input.value = typeData[paramMap[param]];
              input.onblur = () => {
                let v = parseFloat(input.value);
                if (!isNaN(v)) {
                  v = Math.round(v / input.step) * input.step;
                  v = Math.max(input.min, Math.min(input.max, v));
                  input.value = v;
                  typeData[paramMap[param]] = v;
                } else {
                  input.value = typeData[paramMap[param]];
                }
              };
              col.appendChild(label);
              col.appendChild(input);
              row.appendChild(col);
            });

            if (row.children.length > 0) content.appendChild(row);
          });

          section.appendChild(header);
          section.appendChild(content);

          if (program.startsWith("AUTO")) autoContainer.appendChild(section);
          else if (program === "BYP") bypassSection = section;
          else manualSections.push(section);
        });

        manualSections.forEach((s) => manContainer.appendChild(s));
        if (bypassSection) manContainer.appendChild(bypassSection);
      }

      async function loadDefaultJson() {
        try {
          const res = await fetch(
            currentAircraftType === "F-16C_50"
              ? "F-16CM_bl50_DTC_1_DEFAULT.json"
              : "FA-18C_Lot20_DTC1_DEFAULT.json"
          );
          jsonData = await res.json();
          renderConfigurator();
          renderCommTab();
        } catch {
          alert("Failed to load default configuration.");
        }
      }

      document.getElementById("fileInput").addEventListener("change", function (e) {
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            jsonData = JSON.parse(event.target.result);

            // Automatically switch aircraft
            const detectedType = jsonData?.type || jsonData?.data?.type;
            if (detectedType && aircraftCapabilities[detectedType]) {
              currentAircraftType = detectedType;
              document.getElementById("aircraftSelect").value = detectedType;
              updateTabVisibilityForAircraft(detectedType);
            }

            if (jsonData?.data?.COMM) {
              ["COMM1", "COMM2"].forEach((commKey) => {
                const comm = jsonData.data.COMM[commKey];
                if (comm) {
                  Object.entries(comm).forEach(([chan, details]) => {
                    if (chan.startsWith("Channel_") && !("name" in details)) {
                      details.name = `CH ${chan.replace("Channel_", "")}`;
                    }
                  });
                }
              });
            }

            renderTabButtons();
            renderConfigurator();
            renderCommTab();
          } catch {
            alert("Invalid DTC file.");
          }
        };
        reader.readAsText(e.target.files[0]);
      });

      document.getElementById("threatSearch").addEventListener("input", () => {
        renderThreatTable(currentThreatCategory);
      });

      document.getElementById("aircraftSelect").addEventListener("change", (e) => {
        const selected = e.target.value;
        currentAircraftType = selected;

        updateTabVisibilityForAircraft(selected);

        const caps = aircraftCapabilities[selected];
        const fallbackTab = caps.hasPrograms
          ? "programTab"
          : caps.hasThreatTable
          ? "threatTab"
          : "commTab";

        const tabToShow = caps[`has${capitalize(currentTabId.replace("Tab", ""))}`]
          ? currentTabId
          : fallbackTab;

        switchTab(tabToShow);

        // Load appropriate default JSON when switching aircraft
        loadDefaultJson();
      });

      updateTabVisibilityForAircraft(currentAircraftType);
      applyTheme();
      loadDefaultJson();
    </script>
  </body>
</html>
